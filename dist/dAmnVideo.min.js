var dVideo={};dVideo.VERSION="0.0.1";dVideo.STATE="alpha";dVideo.REVISION="0.0.1";dVideo.bots=["botdom","damnphone"];dVideo.peer_options={iceServers:[{url:"stun:stun.l.google.com:19302"}]};dVideo.phone=null;dVideo.signal=null;dVideo.local={};dVideo.local.stream=null;dVideo.local.url=null;dVideo.remote={};dVideo.remote._empty={video:null,audio:null,conn:null};dVideo.chan={};dVideo.chan.group=false;dVideo.chan.calls=[];dVideo.RTC={PeerConnection:null,SessionDescription:null,IceCandidate:null,};dVideo._gum=function(){};dVideo.getUserMedia=function(b,c,a){return dVideo._gum(b,c,a)};if(window.mozRTCPeerConnection){dVideo.RTC.PeerConnection=mozRTCPeerConnection;dVideo.RTC.SessionDescription=mozRTCSessionDescription;dVideo.RTC.IceCandidate=mozRTCIceCandidate;dVideo._gum=function(b,c,a){return navigator.mozGetUserMedia(b,c,a)}}if(window.webkitRTCPeerConnection){dVideo.RTC.PeerConnection=webkitRTCPeerConnection;dVideo._gum=function(b,c,a){return navigator.webkitGetUserMedia(b,c,a)}}if(window.RTCPeerConnection){dVideo.RTC.PeerConnection=RTCPeerConnection;
dVideo._gum=function(b,c,a){return navigator.getUserMedia(b,c,a)}}if(window.RTCSessionDescription){dVideo.RTC.SessionDescription=RTCSessionDescription;dVideo.RTC.IceCandidate=RTCIceCandidate}dVideo.extension=function(b){if(!dVideo.RTC.PeerConnection){return}var d=function(){b.bds.provides.push("PEER");dVideo.create_phone(b);b.bind("BDS.PEER.REQUEST",function(e){dVideo.phone.signal.request(e)});b.bind("BDS.PEER.ACK",function(e){dVideo.phone.signal.ack(e)});b.bind("BDS.PEER.REJECT",function(e){dVideo.phone.signal.reject(e)});b.bind("BDS.PEER.ACCEPT",function(e){dVideo.phone.signal.accept(e)});b.bind("BDS.PEER.OPEN",function(e){dVideo.phone.signal.open(e)});b.bind("BDS.PEER.END",function(e){dVideo.phone.signal.end(e)});b.bind("BDS.PEER.OFFER",function(e){dVideo.phone.signal.offer(e)});b.bind("BDS.PEER.ANSWER",function(e){dVideo.phone.signal.answer(e)});b.bind("BDS.PEER.CLOSE",function(e){dVideo.phone.signal.close(e)});b.ui.control.add_button({label:"",icon:"camera",title:"Start a video call.",href:"#call",handler:function(){dVideo.create_phone(b)
}})};var a={};var c={};d()};dVideo.create_phone=function(a){if(dVideo.phone){return}dVideo.phone=new dVideo.Phone(a)};dVideo.Phone=function(b){console.log("making phone");this.call=null;this.client=b;this.stream=null;this.url=null;this.view=null;this.signal={};this.build();var a=this;this.signal={request:function(d){if(d.sns[0]!="@"){return}var c=d.param[0];var e=d.param[1];if(b.ui.umuted.indexOf(c.toLowerCase())!=-1){b.npmsg(d.ns,"BDS:PEER:REJECT:"+e+","+c+",You have been blocked");return}if(b.away.on){b.npmsg(d.ns,"BDS:PEER:REJECT:"+e+","+c+",Away; "+b.away.reason);return}if(a.call!=null){if(!a.call.group){b.npmsg(d.ns,"BDS:PEER:REJECT:"+e+","+c+",Already in a call");return}}b.npmsg(d.ns,"BDS:PEER:ACK:"+e+","+c);a.incoming(e,c,d)},ack:function(c){},reject:function(c){if(c.sns[0]!="@"){return}},accept:function(e){if(e.sns[0]!="@"){return}if(!a.call){return}var d=dVideo.phone.call;var h=e.param[0];var c=e.param[1];var g=e.param[2]||e.ns;if(c.toLowerCase()!=b.settings.username.toLowerCase()){return
}var f=a.call.new_peer(h,e.user);if(!f){return}f.conn.ready(function(){dVideo.signal.offer(f)})},open:function(c){},end:function(c){},offer:function(f){if(f.sns[0]!="@"){return}if(!a.call){return}var d=a.call;var i=f.param[0];var c=f.param[1];var h=f.param[2];var e=new dVideo.RTC.SessionDescription(JSON.parse(f.param.slice(3).join(",")));if(h.toLowerCase()!=b.settings.username.toLowerCase()){return}if(b.ui.umuted.indexOf(c.toLowerCase())!=-1){dVideo.signal.reject(c,"You have been blocked");return}if(b.away.on){dVideo.signal.reject(c,"Away, reason: "+b.away.reason);return}var g=d.peer(c);if(!g){if(!d.group){return}g=d.new_peer(i,c)}g.conn.ready(function(){dVideo.signal.answer(g);console.log("new peer",g.user)},e)},answer:function(f){if(f.sns[0]!="@"){return}if(!a.call){return}var d=a.call;var i=f.param[0];var c=f.param[1];var h=f.param[2];var e=new dVideo.RTC.SessionDescription(JSON.parse(f.param.slice(3).join(",")));if(h.toLowerCase()!=b.settings.username.toLowerCase()){return}var g=d.peer(c);
if(!g){return}g.conn.open(function(){console.log("> connected to new peer "+g.user)},e)},candidate:function(f){if(f.sns[0]!="@"){return}if(!a.call){return}var e=a.call;var i=f.param[0];var c=f.param[1];var h=f.param[2];var d=new dVideo.RTC.SessionDescription(JSON.parse(f.param.slice(3).join(",")));if(h.toLowerCase()!=b.settings.username.toLowerCase()){return}var g=e.peer(c);if(!g){return}g.conn.candidate(d)},close:function(c){},}};dVideo.Phone.prototype.build=function(){this.client.ui.view.append('<div class="phone"></div>');this.view=this.client.ui.view.find("div.phone")};dVideo.Phone.prototype.get_media=function(c,a){var b=function(){};c=c||b;a=a||b;dVideo.getUserMedia({video:true,audio:true},function(d){dVideo.phone.got_media(d);c(d);console.log("got stream")},function(d){a(d);console.log(d)})};dVideo.Phone.prototype.got_media=function(a){dVideo.phone.url=URL.createObjectURL(a);dVideo.phone.stream=a};dVideo.Phone.prototype.dial=function(a,d,b,c){if(this.call!=null){return this.call}b=b||a;
this.call=new dVideo.Phone.Call(this,a,b,d,c);dVideo.signal.request();return this.call};dVideo.Phone.prototype.incoming=function(g,b,e){var a=this.client;if(this.call==null){var c=a.ui.pager.notice({ref:"call-"+b,icon:'<img src="'+wsc.dAmn.avatar.src(b,a.channel(e.ns).info.members[b].usericon)+'" />',heading:b+" calling...",content:b+" is calling you.",buttons:{answer:{ref:"answer",target:"answer",label:"Answer",title:"Answer the call",click:function(){a.ui.pager.remove_notice(c);dVideo.phone.answer(e.ns,e.param[2]||e.ns,g,b);return false}},reject:{ref:"reject",target:"reject",label:"Reject",title:"Reject the call",click:function(){a.npmsg(e.ns,"BDS:PEER:REJECT:"+g+","+b);a.ui.pager.remove_notice(c);return false}}}},true);c.onclose=function(){a.npmsg(e.ns,"BDS:PEER:REJECT:"+e.user)};return}var f=this.call.new_peer(g,b);var d=this.call;if(!f){dVideo.signal.reject(b,"Permission denied");return}if(!this.call.group){dVideo.signal.accept(b);return}f.conn.ready(function(){dVideo.signal.offer(f)
})};dVideo.Phone.prototype.answer=function(a,c,e,b){this.call=new dVideo.Phone.Call(this,a,c,e,b);var d=this.call.new_peer(e,b);if(!d){dVideo.signal.reject(b,"Permission denied");this.call.close();this.call=null;return}dVideo.signal.accept(b)};dVideo.Phone.Call=function(b,a,d,e,c){this.phone=b;this.bds=a;this.pns=e;this.ns=d;this.user="";this.peers={};this.spns=this.pns.split("-");this.ans=this.spns.shift();this.rns=this.spns.join(" ");this.group=dVideo.bots.indexOf(this.ns.substr(1))!=-1;this.user=c||this.spns[0].substr(1);this.dans=b.client.deform_ns(this.ans);dVideo.create_signaling_channel(this.phone.client,a,e,d);dVideo.getUserMedia({video:true,audio:true},function(f){dVideo.phone.url=URL.createObjectURL(f);dVideo.phone.stream=f;console.log("got stream")},function(f){console.log(f)})};dVideo.Phone.Call.prototype.close=function(){for(var a in this.peers){if(!this.peers.hasOwnProperty(a)){continue}this.peers[a].conn.close()}};dVideo.Phone.Call.prototype.new_peer=function(c,a){if(this.pns!=c){return null
}if(!this.group){if(this.dans.substr(1).toLowerCase()!=a.toLowerCase()){return null}}var b={user:a,conn:dVideo.peer_connection(a),stream:null,url:null};this.peers[a]=b;return b};dVideo.Phone.Call.prototype.peer=function(a){return this.peers[a]||null};dVideo.SignalChannel=function(b,a,d,c){this.user=b.settings.username;this.nse=c?","+c:"";this.bds=this.bds;this.pns=this.pns;this.ns=c;this.client=b};dVideo.SignalChannel.prototype.request=function(){this.client.npmsg(this.bds,"BDS:PEER:REQUEST:"+this.user+","+this.pns+","+this.nse)};dVideo.SignalChannel.prototype.accept=function(a){this.client.npmsg(this.bds,"BDS:PEER:ACCEPT:"+this.pns+","+a+this.nse)};dVideo.SignalChannel.prototype.offer=function(a){this.client.npmsg(this.bds,"BDS:PEER:OFFER:"+this.pns+","+this.user+","+a.user+","+JSON.stringify(a.conn.offer))};dVideo.SignalChannel.prototype.answer=function(a){this.client.npmsg(this.bds,"BDS:PEER:ANSWER:"+this.pns+","+this.user+","+a.user+","+JSON.stringify(a.conn.offer))};dVideo.SignalChannel.prototype.candidate=function(b,a){this.client.npmsg(this.bds,"BDS:PEER:CANDIDATE:"+this.pns+","+this.user+","+b.user+","+JSON.stringify(a))
};dVideo.SignalChannel.prototype.reject=function(a,b){b=b?","+b:"";this.client.npmsg(this.bds,"BDS:PEER:REJECT:"+this.pns+","+a+b)};dVideo.SignalChannel.prototype.close=function(a){this.client.npmsg(this.bds,"BDS:PEER:CLOSE:"+this.pns+","+(a||this.user))};dVideo.SignalChannel.prototype.list=function(a){a=a?":"+a:"";this.client.npmsg(this.bds,"BDS:PEER:LIST"+a)};dVideo.peer_connection=function(a,b){if(!dVideo.RTC.PeerConnection){return null}return new dVideo.PeerConnection(a,b)};dVideo.PeerConnection=function(a,b){this.user=a;this.pc=new dVideo.RTC.PeerConnection(dVideo.peer_options);this.offer="";this.remote_offer=b||null;this.responding=this.remote_offer!=null;this.streamed=false;this.bindings();if(this.remote_offer){this.set_remote_description(this.remote_offer)}};dVideo.PeerConnection.prototype.bindings=function(){var b=this;var a=this.user;this.pc.onicecandidate=function(d){dVideo.signal.candidate(dVideo.phone.call.peer(a),d)};var c=function(){};this.onready=c;this.onopen=c};dVideo.PeerConnection.prototype.ready=function(a,d){this.onready=a||this.onready;
this.remote_offer=d||this.remote_offer;this.responding=this.remote_offer!=null;if(this.responding){var c=this.onopen;var b=this;this.onopen=function(){b.answer();b.onopen=c};this.set_remote_description(this.remote_offer);return}this.create_offer()};dVideo.PeerConnection.prototype.open=function(a,b){if(!this.offer){return}this.remote_offer=b||this.remote_offer;this.onopen=a;if(!this.remote_offer){return}this.set_remote_description(this.remote_offer)};dVideo.PeerConnection.prototype.close=function(){this.pc.close()};dVideo.PeerConnection.prototype.onerror=function(a){console.log(">> Got an error:",'"',a.message,'"',a)};dVideo.PeerConnection.prototype.candidate=function(a){this.pc.addIceCandidate(a)};dVideo.PeerConnection.prototype.create_offer=function(){var a=this;this.pc.createOffer(function(b){a.offer_created(b)},function(b){a.onerror(b)})};dVideo.PeerConnection.prototype.offer_created=function(b){this.offer=b;var a=this;this.pc.setLocalDescription(this.offer,function(){a.local_description_set()
},this.onerror)};dVideo.PeerConnection.prototype.set_remote_description=function(b){this.remote_offer=b;var a=this;this.pc.setRemoteDescription(this.remote_offer,function(){a.remote_description_set()},this.onerror)};dVideo.PeerConnection.prototype.local_description_set=function(){this.onready()};dVideo.PeerConnection.prototype.remote_description_set=function(){this.onopen()};dVideo.PeerConnection.prototype.answer=function(){var a=this;this.responding=true;this.pc.createAnswer(function(b){a.answer_created(b)},function(b){a.onerror(b)})};dVideo.PeerConnection.prototype.answer_created=function(b){this.offer=b;var a=this;this.pc.setLocalDescription(this.offer,function(){a.local_description_set()},function(c){a.onerror(c)})};