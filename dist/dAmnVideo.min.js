var dVideo={};dVideo.VERSION="0.4.10";dVideo.STATE="alpha";dVideo.REVISION="0.4.10";dVideo.APPNAME="dAmnVideo";dVideo.APPVERSION=1;dVideo.bots=["botdom","damnphone"];dVideo.peer_options={iceServers:[{url:"stun:stun.l.google.com:19302"}]};dVideo.phone=null;dVideo.signal=null;dVideo.local={};dVideo.local.stream=null;dVideo.local.url=null;dVideo.remote={};dVideo.remote._empty={video:null,audio:null,conn:null};dVideo.chan={};dVideo.chan.group=false;dVideo.chan.calls=[];dVideo.extension=function(b){if(!wsc.dAmn.BDS.Peer.RTC.PeerConnection){return}var d=function(){b.bds.provides.push("PEER");dVideo.create_phone(b);b.bind("peer.request",function(e){dVideo.phone.signal.request(e)});b.bind("peer.accept",function(e){dVideo.phone.signal.accept(e)});b.bind("peer.close",function(e){dVideo.phone.signal.close(e)});b.bind("recv_part",function(e){c.recv_part(e)});b.ui.control.add_button({label:"",icon:"iphone",title:"Start a video call.",href:"#call",handler:function(){var g=b.ui.chatbook.current;if(g.namespace[0]=="#"){alert("Group calls not implemented yet! If you want group calls, let photofroggy know.");
return}var f=g.raw;var e=g.namespace.substr(1);var h="Private Call";if(b.channel(f).get_usernames().indexOf(e)==-1){alert("Other user must be in the channel before calling.");return}dVideo.phone.dial(f,f+":"+h,g.namespace,h,e)}})};var a={};var c={recv_part:function(f){var e=dVideo.phone.call;if(!e){return}if(f.ns!=e.ns){return}dVideo.phone.hangup(e)}};d()};dVideo.create_phone=function(a){if(dVideo.phone){return}dVideo.phone=new dVideo.Phone(a)};dVideo.Phone=function(a){this.call=null;this.client=a;this.stream=null;this.url=null;this.view=null;this.signal={};this.build();this.signal=new dVideo.SignalHandler(this,this.client)};dVideo.Phone.prototype.build=function(){this.client.ui.view.append('<div class="phone"></div>');this.view=this.client.ui.view.find("div.phone")};dVideo.Phone.prototype.get_media=function(c,a){var b=function(){};c=c||b;a=a||b;this.client.ui.get_user_media({video:true,audio:true},function(d){dVideo.phone.got_media(d);c(d)},function(d){a(d)})};dVideo.Phone.prototype.got_media=function(a){this.url=URL.createObjectURL(a);
this.stream=a};dVideo.Phone.prototype.dial=function(a,g,e,h,c){if(this.call!=null){return this.call}if(e[0]!="@"){return}var d=client.bds.peer.open(a,g,c,dVideo.APPNAME,dVideo.APPVERSION);var f=d.new_peer(c);d.onclose=function(){dVideo.phone.call=null;client.ui.chatbook.channel(d.ns).server_message("Call Ended")};f.onclose=function(){console.log("> peer connection closed.");d.close()};var b=function(){d.signal.request()};this.viewport(d,f);this.get_media(function(){d.set_local_stream(dVideo.phone.stream);f.set_local_stream(dVideo.phone.stream);b()},b);this.call=d;return d};dVideo.Phone.prototype.incoming=function(c,d){var a=this.client;var b=null;if(this.call==null){b=a.ui.pager.notice({ref:"call-"+d.user,icon:'<img src="'+wsc.dAmn.avatar.src(d.user,a.channel(c.ns).info.members[d.user].usericon)+'" />',heading:"Incoming Call",content:d.user+" is calling you.",buttons:{answer:{ref:"answer",target:"answer",label:"Answer",title:"Answer the call",click:function(){a.ui.pager.remove_notice(b);
dVideo.phone.answer(c,d);return false}},reject:{ref:"reject",target:"reject",label:"Reject",title:"Reject the call",click:function(){c.signal.reject(d.user);a.ui.pager.remove_notice(b);return false}}}},true);b.onclose=function(){c.signal.reject(d.user);b=null};d.onclose=function(){console.log("> close",d);c.close();if(!b){return}a.ui.pager.remove_notice(b)};c.onclose=function(){dVideo.phone.call=null;a.ui.chatbook.channel(c.ns).server_message("Call Ended")};return}if(!this.call.group){return}d.onicecompleted=function(){console.log("> finished ice.")};d.onlocaldescription=function(){c.signal.offer(d)};d.onremotedescription=function(){a.ui.chatbook.channel(c.ns).server_message("Call Started");d.persist()};d.onclose=function(){console.log("> close",d);c.close();if(!b){return}a.ui.pager.remove_notice(b)};c.onclose=function(){dVideo.phone.call=null;a.ui.chatbook.channel(c.ns).server_message("Call Ended")};d.create_offer()};dVideo.Phone.prototype.answer=function(b,c){this.call=b;if(b.group){return
}var a=function(){if(b.localstream){c.set_local_stream(b.localstream)}b.signal.accept(c.user)};this.viewport(b,c);this.get_media(function(){b.set_local_stream(dVideo.phone.stream);c.set_local_stream(dVideo.phone.stream);a()},a)};dVideo.Phone.prototype.viewport=function(j,g){var e=this.client.ui.chatbook.channel(j.ns);e.ulbuf+=250;e.resize();var h=e.el.l.p.height();e.el.l.p.after('<div class="phone private">            <div class="title">                <h2>'+j.title+'</h2>            </div>            <div class="viewport remote">                <div class="video">                    <video autoplay></video>                </div>                <div class="label">                    <span class="label">'+g.user+'</span>                    <ul class="control">                        <li><a href="#pause" title="Pause webcam" class="toggle pause remote">Pause</a></li>                        <li><a href="#mute" title="Mute webcam" class="toggle mute remote">Mute</a></li>                    </ul>                </div>            </div>            <div class="viewport local">                <div class="video">                    <video autoplay muted></video>                </div>                <div class="label">                    <span class="label">You</span>                    <ul class="control">                        <li><a href="#pause" title="Pause your webcam" class="toggle pause">Pause</a></li>                        <li><a href="#mute" title="Mute your microphone" class="toggle mute">Mute</a></li>                    </ul>                </div>            </div>            <div class="control">                <ul>                    <li><a href="#hangup" title="End the call" class="button hangup">Hang Up</a></li>                </u>            </div>        </div>');
var b=e.el.m.find("div.phone");b.height(h);b.find(".control .hangup").click(function(){dVideo.phone.hangup(j,g);return false});var a=b.find(".viewport.remote video");var f=b.find(".viewport.local video");if(this.url){f[0].src=this.url}var c=function(k){k=Object.extend({mic:false,text:{pause:"Play",play:"Pause"}},(k||{}));return function(){var l=b.find(this);var m=l.hasClass("remote");if(l.hasClass("paused")){d(k.mic,m);l.text(k.text.play);l.removeClass("paused");return false}i(k.mic,m);l.text(k.text.pause);l.addClass("paused");return false}};b.find(".label .control .toggle.pause").click(c());b.find(".label .control .toggle.mute").click(c({mic:true,text:{pause:"Unmute",play:"Mute"}}));var i=function(o,p){var m=[];var k=0;if(o){if(p){m=g.remotemic}else{m=j.localmic}}else{if(p){m=g.remotevideo}else{m=j.localvideo}}k=m.length;if(k==0){return}for(var n=0;n<k;n++){m[n].enabled=false}};var d=function(o,p){var m=[];var k=0;if(o){if(p){m=g.remotemic}else{m=j.localmic}}else{if(p){m=g.remotevideo}else{m=j.localvideo
}}k=m.length;if(k==0){return}for(var n=0;n<k;n++){m[n].enabled=true}};j.localmic=[];j.localvideo=[];j.onlocalstream=function(){f[0].src=j.localurl;j.localmic=j.localstream.getAudioTracks();j.localvideo=j.localstream.getVideoTracks()};g.vp=a[0];g.remotemic=[];g.remotevideo=[];g.onremotestream=function(){a[0].src=URL.createObjectURL(g.remote_stream);g.remotemic=g.remote_stream.getAudioTracks();g.remotevideo=g.remote_stream.getVideoTracks();console.log(a[0].src)}};dVideo.Phone.prototype.hangup=function(a,b){this.destroy_call(a);if(a.group){return}a.close()};dVideo.Phone.prototype.destroy_call=function(a){if(a!=this.call){return}if(a.localstream){a.localstream.stop()}this.client.bds.peer.remove(a.pns);var b=this.client.ui.chatbook.channel(a.ns);b.el.m.find("div.phone").remove();b.ulbuf-=250;b.resize();this.call=null};dVideo.SignalHandler=function(b,a){this.phone=b;this.client=a};dVideo.SignalHandler.prototype.request=function(c){if(dVideo.APPNAME!=c.call.app&&c.call.app_ver>=dVideo.APPVERSION){return
}var b=c.call;var d=c.peer;var a=dVideo.phone;if(this.client.ui.umuted.indexOf(d.user.toLowerCase())!=-1){b.signal.reject(d.user,"You have been blocked");return false}if(this.client.away.on){b.signal.reject(d.user,"Away; "+client.away.reason);return false}if(a.call!=null){if(a.call!=b||!b.group){b.signal.reject(d.user,"Already in a call");return false}}d.onicecompleted=function(){console.log("> finished ice.")};d.onremotedescription=function(){d.create_answer()};d.onlocaldescription=function(){b.signal.answer(d);dVideo.phone.client.ui.chatbook.channel(b.ns).server_message("Call Started");d.persist()};d.onclose=function(){b.close();a.client.client.ui.pager.remove_notice(pnotice)};a.incoming(b,d)},dVideo.SignalHandler.prototype.ack=function(a){};dVideo.SignalHandler.prototype.reject=function(a){};dVideo.SignalHandler.prototype.accept=function(b){if(dVideo.APPNAME!=b.call.app){return}var a=b.call;var c=b.peer;c.onicecompleted=function(){console.log("> finished ice.");if(c.remote_stream!=null){return
}var d=c.pc.getRemoteStreams();if(d.length==0){return}console.log("> got a stream");c.remote_stream=d[0];c.vp.src=URL.createObjectURL(c.remote_stream)};c.onlocaldescription=function(){a.signal.offer(c)};c.onremotedescription=function(){dVideo.phone.client.ui.chatbook.channel(a.ns).server_message("Call Started");c.persist()};c.onclose=function(){a.close();phone.client.client.ui.pager.remove_notice(pnotice)};c.create_offer()};dVideo.SignalHandler.prototype.open=function(a){};dVideo.SignalHandler.prototype.end=function(a){};dVideo.SignalHandler.prototype.offer=function(c){if(dVideo.APPNAME!=c.call.app){return}var a=c.call;var d=c.peer;var b=c.offer;d.onremotedescription=function(){d.answer()};d.ready(function(){a.signal.answer(d);console.log("> connected to new peer",d.user)},b)};dVideo.SignalHandler.prototype.answer=function(b){if(dVideo.APPNAME!=b.call.app){return}var a=b.call;var c=b.peer;var c=a.peer(c.user);if(!c){return}c.open(function(){console.log("> connected to new peer ",c.user)
},b.answer)};dVideo.SignalHandler.prototype.candidate=function(d){var c=phone.call;var g=d.param[0];var a=d.param[1];var f=d.param[2];console.log(d.param.slice(3));var b=new dVideo.RTC.SessionDescription(JSON.parse(d.param.slice(3).join(",")));if(f.toLowerCase()!=client.settings.username.toLowerCase()){return}var e=c.peer(a);if(!e){return}e.conn.candidate(b)};dVideo.SignalHandler.prototype.close=function(a){};